<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SubEnum v4.2 • Root + PSL Smart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap');
        body { font-family: 'Space Grotesk', sans-serif; }
        .log-line { font-family: ui-monospace, monospace; }
        .pill { transition: all 0.2s cubic-bezier(0.4,0,0.2,1); }
        .pill:hover { transform: translateY(-2px) scale(1.03); }
        #trafficCanvas { background: #18181b; border-radius: 24px; }
    </style>
</head>
<body class="bg-zinc-950 text-zinc-200">
<div class="min-h-screen flex">
    <!-- Sidebar -->
    <div class="w-96 bg-zinc-900 border-r border-zinc-800 p-6 flex flex-col overflow-y-auto">
        <div class="flex items-center gap-3 mb-8">
            <div class="w-10 h-10 bg-gradient-to-br from-violet-500 to-fuchsia-500 rounded-3xl flex items-center justify-center text-black font-black text-2xl">S</div>
            <div>
                <h1 class="text-3xl font-bold tracking-tighter">SubEnum <span class="text-xs text-violet-400 align-super">v4.2</span></h1>
                <p class="text-xs text-zinc-500 -mt-1">root domain • smart PSL</p>
            </div>
        </div>

        <div class="space-y-7">
            <!-- Target -->
            <div>
                <label class="block text-sm font-medium text-zinc-400 mb-1.5">TARGET DOMAIN</label>
                <input id="target" type="text" value="pwndefend.com" 
                       class="w-full bg-zinc-800 border border-zinc-700 rounded-3xl px-5 py-4 text-lg focus:outline-none focus:border-violet-500">
            </div>

            <!-- DNS Providers -->
            <div>
                <label class="block text-sm font-medium text-zinc-400 mb-3">DNS PROVIDERS (round-robin)</label>
                <div id="providerCheckboxes" class="grid grid-cols-2 gap-2"></div>
                <div class="mt-4 flex gap-3">
                    <input id="customDoh" placeholder="https://your-doh.example.com/dns-query" 
                           class="flex-1 bg-zinc-800 border border-zinc-700 rounded-3xl px-5 py-3 text-sm font-mono">
                    <button onclick="addCustomProvider()" 
                            class="bg-zinc-800 hover:bg-zinc-700 px-6 rounded-3xl text-sm font-medium">ADD</button>
                </div>
                <div id="customProvidersList" class="mt-3 space-y-1 text-xs"></div>
            </div>

            <!-- WORDLIST -->
            <div>
                <div class="flex justify-between items-center mb-1.5">
                    <label class="block text-sm font-medium text-zinc-400">WORDLIST</label>
                    <button onclick="uploadWordlist()" 
                            class="text-xs px-3 py-1 bg-zinc-800 hover:bg-zinc-700 rounded-xl flex items-center gap-1">
                        <i class="fa-solid fa-upload"></i> Upload
                    </button>
                </div>
                <textarea id="wordlist" rows="6" 
                          class="w-full bg-zinc-800 border border-zinc-700 rounded-3xl p-4 text-sm font-mono resize-none focus:outline-none focus:border-violet-500">www
api
admin
dev
test
staging
prod
beta
demo
shop
blog
app
mobile
login
portal
dashboard
cdn
static
assets
media
internal
secure
auth
vpn
git
jenkins</textarea>
            </div>

            <!-- Record Types -->
            <div>
                <label class="block text-sm font-medium text-zinc-400 mb-3">RECORD TYPES</label>
                <div id="recordTypeCheckboxes" class="grid grid-cols-4 gap-2"></div>
            </div>

            <!-- PSL & Root Domain -->
            <div>
                <label class="block text-sm font-medium text-zinc-400 mb-2">ROOT DOMAIN & PSL</label>
                <div class="flex items-center gap-3 bg-zinc-800 rounded-3xl p-4">
                    <input type="checkbox" id="usePSL" checked class="accent-violet-500 w-5 h-5">
                    <div>
                        <div class="text-sm">Smart base detection</div>
                        <div class="text-xs text-zinc-500">Respects gov.uk, co.uk, etc.</div>
                    </div>
                </div>
                <button onclick="loadFullPSL()" 
                        class="mt-3 w-full bg-zinc-800 hover:bg-zinc-700 py-3 rounded-3xl text-sm font-medium flex items-center justify-center gap-2">
                    <i class="fa-solid fa-globe"></i> Load Full Public Suffix List (Mozilla)
                </button>
                <div id="pslStatus" class="text-[10px] text-emerald-400 mt-1 text-center">Built-in PSL active (50+ suffixes)</div>
            </div>

            <!-- Settings -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs text-zinc-400 mb-1">CONCURRENCY</label>
                    <input id="concurrency" type="range" min="5" max="100" value="25" class="w-full accent-violet-500">
                    <div id="concurrencyValue" class="text-center text-sm font-mono text-violet-400">25</div>
                </div>
                <div>
                    <label class="block text-xs text-zinc-400 mb-1">MAX DEPTH</label>
                    <select id="maxDepth" class="w-full bg-zinc-800 border border-zinc-700 rounded-3xl px-5 py-4 text-sm">
                        <option value="1">1</option>
                        <option value="2" selected>2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                    </select>
                </div>
            </div>

            <!-- Progress -->
            <div id="progressSection" class="hidden">
                <div class="flex justify-between text-xs text-zinc-400 mb-1">
                    <span>PROGRESS</span>
                    <span id="progressPercent" class="font-mono text-violet-400">0%</span>
                </div>
                <div class="h-2.5 bg-zinc-800 rounded-full overflow-hidden">
                    <div id="progressBar" class="h-full bg-gradient-to-r from-violet-500 via-fuchsia-500 to-cyan-400 w-0 transition-all"></div>
                </div>
                <div class="mt-1 flex justify-between text-[10px] font-mono text-zinc-500">
                    <span>Depth <span id="currentDepth">1</span>/<span id="maxD">2</span></span>
                    <span><span id="checksDone">0</span>/<span id="checksTotal">0</span></span>
                </div>
            </div>

            <button onclick="startScan()" id="startBtn" 
                    class="w-full bg-violet-600 hover:bg-violet-500 py-4 rounded-3xl font-semibold flex items-center justify-center gap-2">
                <i class="fa-solid fa-bolt"></i> START SCAN
            </button>

            <button onclick="stopScan()" id="stopBtn" 
                    class="w-full py-3 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-3xl hidden font-medium">STOP SCAN</button>
        </div>

        <div class="mt-auto pt-8 text-[10px] text-zinc-500">v4.2 • Root domain always checked • PSL smart base detection</div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col">
        <div class="border-b border-zinc-800 px-8 py-5 flex items-center justify-between bg-zinc-900">
            <div class="flex gap-6">
                <button onclick="showTab(0)" id="tab0" class="tab-btn active px-6 py-2 rounded-3xl text-sm font-medium">RESULTS</button>
                <button onclick="showTab(1)" id="tab1" class="tab-btn px-6 py-2 rounded-3xl text-sm font-medium">LOG</button>
                <button onclick="showTab(2)" id="tab2" class="tab-btn px-6 py-2 rounded-3xl text-sm font-medium">DASHBOARD</button>
            </div>
            <div class="flex gap-3">
                <button onclick="clearResults()" class="px-5 py-2 text-xs border border-zinc-700 rounded-3xl hover:bg-zinc-800">CLEAR</button>
                <button onclick="exportCSV()" class="px-5 py-2 text-xs bg-zinc-800 hover:bg-zinc-700 rounded-3xl">EXPORT CSV</button>
            </div>
        </div>

        <div id="tabContent0" class="flex-1 overflow-auto p-8">
            <table class="w-full">
                <thead class="bg-zinc-900 sticky top-0 z-10">
                    <tr class="text-xs text-zinc-400 border-b border-zinc-800">
                        <th class="py-5 px-6 text-left">#</th>
                        <th class="py-5 px-6 text-left">SUBDOMAIN</th>
                        <th class="py-5 px-6 text-left">IPs</th>
                        <th class="py-5 px-6 text-left">CNAME</th>
                        <th class="py-5 px-6 text-left">OTHER</th>
                        <th class="py-5 px-6 text-left">DEPTH</th>
                        <th class="py-5 px-6 w-20"></th>
                    </tr>
                </thead>
                <tbody id="resultsBody" class="text-sm divide-y divide-zinc-800"></tbody>
            </table>
        </div>

        <div id="tabContent1" class="flex-1 overflow-auto p-8 hidden bg-black">
            <div id="log" class="font-mono text-xs text-zinc-300 space-y-1 h-full overflow-auto"></div>
        </div>

        <div id="tabContent2" class="flex-1 overflow-auto p-8 hidden bg-zinc-950">
            <div class="max-w-7xl mx-auto space-y-8">
                <div class="grid grid-cols-4 gap-6">
                    <div class="bg-zinc-900 rounded-3xl p-6">
                        <div class="text-xs text-zinc-500">TOTAL QUERIES</div>
                        <div id="statQueries" class="text-5xl font-bold text-white mt-2 font-mono">0</div>
                    </div>
                    <div class="bg-zinc-900 rounded-3xl p-6">
                        <div class="text-xs text-zinc-500">SUCCESSFUL</div>
                        <div id="statSuccess" class="text-5xl font-bold text-emerald-400 mt-2 font-mono">0</div>
                    </div>
                    <div class="bg-zinc-900 rounded-3xl p-6">
                        <div class="text-xs text-zinc-500">RATE</div>
                        <div id="statRate" class="text-5xl font-bold text-amber-400 mt-2 font-mono">0/s</div>
                    </div>
                    <div class="bg-zinc-900 rounded-3xl p-6">
                        <div class="text-xs text-zinc-500">SUCCESS %</div>
                        <div id="statSuccessPct" class="text-5xl font-bold text-sky-400 mt-2 font-mono">0%</div>
                    </div>
                </div>

                <div>
                    <div class="text-sm font-medium text-zinc-400 mb-4">DNS PROVIDERS LIVE</div>
                    <div id="providersGrid" class="grid grid-cols-3 gap-4"></div>
                </div>

                <div>
                    <div class="text-sm font-medium text-zinc-400 mb-4 flex items-center gap-3">
                        TRAFFIC FLOW • CLIENT → PROVIDERS
                        <div class="flex-1 h-px bg-zinc-800"></div>
                    </div>
                    <canvas id="trafficCanvas" width="1100" height="220" class="w-full"></canvas>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <div class="bg-zinc-900 rounded-3xl p-6">
                        <div class="text-sm font-medium text-zinc-400 mb-4">RESOLUTIONS OVER TIME</div>
                        <canvas id="lineChart" height="140"></canvas>
                    </div>
                    <div class="bg-zinc-900 rounded-3xl p-6">
                        <div class="text-sm font-medium text-zinc-400 mb-4">REQUESTS PER PROVIDER</div>
                        <canvas id="barChart" height="140"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="border-t border-zinc-800 bg-zinc-900 px-8 py-4 text-xs text-zinc-500 flex justify-between">
            <div>v4.2 • Root domain always enumerated • PSL interface added</div>
            <div id="status" class="font-mono">Ready</div>
        </div>
    </div>
</div>

<input type="file" id="wordlistUpload" accept=".txt" class="hidden" onchange="handleFileUpload(event)">

<script>
    // ================== PUBLIC SUFFIX LIST ==================
    let psl = new Set([
        "com","net","org","edu","gov","mil","int","uk","co.uk","org.uk","gov.uk","ac.uk","me.uk","net.uk","nhs.uk","police.uk","sch.uk",
        "ca","de","fr","it","jp","au","com.au","net.au","org.au","us","co","io","me","biz","info","name","pro","xyz","top","site","online",
        "club","app","dev","cloud","ai","tech","shop","blog","news","tv","fm","cc","gg","sh","to","ws","nu","ac","gg","sh","tv","fm","eu",
        "ch","nl","se","no","dk","fi","be","at","es","pt","gr","pl","cz","hu","ro","sk","si","hr","bg","ee","lt","lv","lu","mt","cy","is",
        "ru","cn","tw","hk","in","br","mx","ar","cl","za","ng","ke","eg","tr","il","ae","sa","kr","vn","th","my","sg","id","ph","nz","pk"
    ]);

    let fullPSLLoaded = false;

    async function loadFullPSL() {
        const status = document.getElementById('pslStatus');
        status.textContent = 'Loading full PSL...';
        status.className = 'text-[10px] text-amber-400 mt-1 text-center';
        try {
            const resp = await fetch('https://raw.githubusercontent.com/publicsuffix/list/master/public_suffix_list.dat');
            const text = await resp.text();
            const lines = text.split('\n');
            psl.clear();
            lines.forEach(line => {
                line = line.trim();
                if (line && !line.startsWith('//') && !line.startsWith('!')) {
                    psl.add(line.toLowerCase());
                }
            });
            fullPSLLoaded = true;
            status.textContent = `Full PSL loaded (${psl.size} suffixes)`;
            status.className = 'text-[10px] text-emerald-400 mt-1 text-center';
            log('Full Public Suffix List loaded successfully', 'success');
        } catch(e) {
            status.textContent = 'Failed – using built-in';
            status.className = 'text-[10px] text-red-400 mt-1 text-center';
            log('Failed to load full PSL – using built-in list', 'error');
        }
    }

    function getRegistrableDomain(domain) {
        if (!domain) return domain;
        const lower = domain.toLowerCase();
        const labels = lower.split('.');
        if (labels.length < 2) return domain;

        let suffix = '';
        for (let i = 1; i <= Math.min(4, labels.length); i++) {
            const candidate = labels.slice(-i).join('.');
            if (psl.has(candidate)) {
                suffix = candidate;
                break;
            }
        }
        if (!suffix) return domain;

        const suffixParts = suffix.split('.').length;
        const start = Math.max(0, labels.length - suffixParts - 1);
        return labels.slice(start).join('.');
    }

    // ================== REST OF THE CODE (same as v4.1 with root + PSL) ==================
    let defaultProviders = [
        { id: "cloudflare", name: "Cloudflare", url: "https://cloudflare-dns.com/dns-query", checked: true },
        { id: "google",     name: "Google",     url: "https://dns.google/resolve", checked: true },
        { id: "quad9",      name: "Quad9",      url: "https://dns.quad9.net/dns-query", checked: false },
        { id: "adguard",    name: "AdGuard",    url: "https://dns.adguard.com/dns-query", checked: false }
    ];

    let customProviders = [];
    let providerIndex = 0;

    const recordTypeList = [
        {value:"A", label:"A", checked:true},
        {value:"AAAA", label:"AAAA", checked:true},
        {value:"CNAME", label:"CNAME", checked:true},
        {value:"MX", label:"MX", checked:false},
        {value:"NS", label:"NS", checked:false},
        {value:"TXT", label:"TXT", checked:false},
        {value:"SRV", label:"SRV", checked:false}
    ];

    let providerStats = {};
    let totalQueries = 0, totalSuccess = 0, lastSecondQueries = 0, rate = 0;
    let resolutionHistory = [];
    let lineChart, barChart;

    let isRunning = false, stopRequested = false;
    let results = [], discovered = new Set();
    let totalChecks = 0, completedChecks = 0, currentDepth = 0;

    const logEl = document.getElementById('log');
    const resultsBody = document.getElementById('resultsBody');
    let trafficCtx, trafficParticles = [];
    let animationFrame;

    function log(msg, type='info') {
        const t = new Date().toLocaleTimeString('en-US',{hour12:false});
        const cls = type==='success'?'text-emerald-400':type==='error'?'text-red-400':'text-zinc-400';
        logEl.innerHTML += `<div class="log-line ${cls}">[${t}] ${msg}</div>`;
        logEl.scrollTop = logEl.scrollHeight;
    }

    function getSelectedProviders() {
        return [...defaultProviders.filter(p => p.checked), ...customProviders];
    }

    function getNextDoHUrl() {
        const list = getSelectedProviders();
        if (!list.length) return {url: defaultProviders[0].url, name: defaultProviders[0].name};
        const p = list[providerIndex % list.length];
        providerIndex = (providerIndex + 1) % list.length;
        return {url: p.url, name: p.name};
    }

    async function resolveSubdomain(sub) {
        const selectedTypes = Array.from(document.querySelectorAll('#recordTypeCheckboxes input:checked')).map(c => c.value);
        const result = { ips: [], cname: null, other: '' };
        const {url, name} = getNextDoHUrl();

        if (!providerStats[name]) providerStats[name] = {requests:0, successes:0};
        providerStats[name].requests++;
        totalQueries++;

        for (const type of selectedTypes) {
            try {
                const resp = await fetch(`${url}?name=${encodeURIComponent(sub)}&type=${type}`, {
                    headers: { 'Accept': 'application/dns-json' }
                });
                if (!resp.ok) continue;
                const data = await resp.json();
                if (!data.Answer) continue;
                data.Answer.forEach(a => {
                    if ((type === 'A' && a.type === 1) || (type === 'AAAA' && a.type === 28)) result.ips.push(a.data);
                    if (type === 'CNAME' && a.type === 5) result.cname = a.data;
                    if (['MX','NS','TXT','SRV'].includes(type) && a.data) {
                        if (result.other) result.other += ', ';
                        result.other += `${type}:${a.data}`;
                    }
                });
            } catch(e){}
        }

        result.ips = [...new Set(result.ips)];
        const success = result.ips.length || result.cname || result.other;
        if (success) { providerStats[name].successes++; totalSuccess++; }

        trafficParticles.push({
            x: 80, y: 110,
            targetX: 520 + (getSelectedProviders().findIndex(p => p.name === name) * 180),
            progress: 0,
            success: success,
            color: success ? '#10b981' : '#ef4444'
        });

        return result;
    }

    function updateLiveStats() {
        document.getElementById('statQueries').textContent = totalQueries;
        document.getElementById('statSuccess').textContent = totalSuccess;
        document.getElementById('statSuccessPct').textContent = totalQueries ? Math.round((totalSuccess/totalQueries)*100) + '%' : '0%';
        const now = Date.now();
        if (now - (window.lastRateTime || 0) > 1000) {
            rate = totalQueries - lastSecondQueries;
            lastSecondQueries = totalQueries;
            window.lastRateTime = now;
        }
        document.getElementById('statRate').textContent = rate + '/s';
    }

    function renderProvidersGrid() {
        const container = document.getElementById('providersGrid');
        container.innerHTML = getSelectedProviders().map(p => {
            const stats = providerStats[p.name] || {requests:0, successes:0};
            const pct = stats.requests ? Math.round((stats.successes / stats.requests) * 100) : 0;
            return `<div class="bg-zinc-900 rounded-3xl p-5 border border-zinc-800">
                <div class="flex justify-between items-start">
                    <div><div class="font-semibold">${p.name}</div><div class="text-xs text-zinc-500 font-mono">${p.url.split('//')[1].split('/')[0]}</div></div>
                    <div class="text-right"><div class="text-2xl font-mono text-emerald-400">${stats.successes}</div><div class="text-xs text-zinc-500">success</div></div>
                </div>
                <div class="mt-4 h-2 bg-zinc-800 rounded-full overflow-hidden"><div class="h-full bg-gradient-to-r from-emerald-400 to-cyan-400" style="width:${pct}%"></div></div>
                <div class="flex justify-between text-xs mt-1"><span class="font-mono">${stats.requests} req</span><span class="text-emerald-400">${pct}%</span></div>
            </div>`;
        }).join('');
    }

    function initTrafficCanvas() {
        trafficCtx = document.getElementById('trafficCanvas').getContext('2d');
    }

    function drawTraffic() {
        trafficCtx.clearRect(0, 0, 1100, 220);
        // Client
        trafficCtx.fillStyle = '#a855f7'; trafficCtx.beginPath(); trafficCtx.arc(80, 110, 28, 0, Math.PI*2); trafficCtx.fill();
        trafficCtx.fillStyle = '#fff'; trafficCtx.font = 'bold 13px monospace'; trafficCtx.textAlign = 'center'; trafficCtx.fillText('YOU', 80, 116);
        // Providers
        const providers = getSelectedProviders();
        providers.forEach((p, i) => {
            const x = 520 + i * 180;
            trafficCtx.fillStyle = '#64748b'; trafficCtx.beginPath(); trafficCtx.arc(x, 110, 26, 0, Math.PI*2); trafficCtx.fill();
            trafficCtx.fillStyle = '#e0f2fe'; trafficCtx.font = '11px monospace'; trafficCtx.fillText(p.name.slice(0,8), x, 115);
        });
        // Particles
        for (let i = trafficParticles.length - 1; i >= 0; i--) {
            const p = trafficParticles[i];
            p.progress += 0.028;
            const x = p.x + (p.targetX - p.x) * p.progress;
            const y = 110 + Math.sin(p.progress * Math.PI * 2) * 12;
            trafficCtx.fillStyle = p.color;
            trafficCtx.beginPath(); trafficCtx.arc(x, y, 6, 0, Math.PI*2); trafficCtx.fill();
            if (p.progress >= 1) trafficParticles.splice(i, 1);
        }
    }

    function startTrafficAnimation() {
        if (animationFrame) cancelAnimationFrame(animationFrame);
        function loop() { drawTraffic(); animationFrame = requestAnimationFrame(loop); }
        loop();
    }

    function initCharts() {
        lineChart = new Chart(document.getElementById('lineChart'), { type: 'line', data: { labels: [], datasets: [{ label: 'Success', borderColor: '#22d3ee', tension: 0.4, data: [] }] }, options: { plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#27272a' } } } } });
        barChart = new Chart(document.getElementById('barChart'), { type: 'bar', data: { labels: [], datasets: [{ label: 'Requests', backgroundColor: '#8b5cf6', data: [] }] }, options: { plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#27272a' } } } } });
    }

    function updateCharts() {
        const now = new Date().toLocaleTimeString([], {minute:'2-digit', second:'2-digit'});
        resolutionHistory.push({time: now, count: totalSuccess});
        if (resolutionHistory.length > 20) resolutionHistory.shift();
        lineChart.data.labels = resolutionHistory.map(h => h.time);
        lineChart.data.datasets[0].data = resolutionHistory.map(h => h.count);
        lineChart.update('none');

        const labels = Object.keys(providerStats);
        barChart.data.labels = labels;
        barChart.data.datasets[0].data = labels.map(n => providerStats[n].requests);
        barChart.update('none');
    }

    function updateDashboard() {
        updateLiveStats();
        renderProvidersGrid();
        updateCharts();
    }

    function createLimiter(max) {
        let running = 0, queue = [];
        return async (task) => {
            if (running >= max) await new Promise(r => queue.push(r));
            running++;
            try { await task(); }
            finally { running--; if (queue.length) queue.shift()(); }
        };
    }

    function addResult(sub, res, depth) {
        if (!res.ips.length && !res.cname && !res.other) return;
        if (discovered.has(sub)) return;
        discovered.add(sub);
        results.push({subdomain:sub, ips:res.ips, cname:res.cname, other:res.other, depth});
        renderResults();
    }

    function renderResults() {
        resultsBody.innerHTML = results.map((r,i) => `
            <tr class="hover:bg-zinc-800/50">
                <td class="py-4 px-6 text-zinc-500">${i+1}</td>
                <td class="py-4 px-6 font-medium text-violet-300">${r.subdomain}</td>
                <td class="py-4 px-6 text-xs font-mono">${r.ips.join('<br>') || '—'}</td>
                <td class="py-4 px-6 text-xs font-mono text-amber-300">${r.cname || '—'}</td>
                <td class="py-4 px-6 text-xs font-mono text-sky-300">${r.other || '—'}</td>
                <td class="py-4 px-6"><span class="px-3 py-1 bg-zinc-800 rounded-full text-xs">${r.depth}</span></td>
                <td class="py-4 px-6"><a href="https://${r.subdomain}" target="_blank" class="text-violet-400"><i class="fa-solid fa-external-link-alt"></i></a></td>
            </tr>
        `).join('');
    }

    async function bruteForce(bases, depth, maxDepth, limiter) {
        if (depth > maxDepth || stopRequested) return;
        currentDepth = depth;
        const words = document.getElementById('wordlist').value.trim().split('\n').map(w => w.trim()).filter(Boolean);
        const batch = bases.length * words.length;
        totalChecks += batch;
        updateProgress();

        const next = [];
        for (const base of bases) {
            for (const word of words) {
                if (stopRequested) break;
                const sub = `${word}.${base}`;
                if (discovered.has(sub)) continue;

                completedChecks++;
                updateProgress();

                const task = async () => {
                    const res = await resolveSubdomain(sub);
                    if (res.ips.length || res.cname || res.other) {
                        log(`✓ ${sub}`, 'success');
                        addResult(sub, res, depth);
                        next.push(sub);
                    }
                };
                await limiter(task);
            }
        }
        if (next.length && depth < maxDepth && !stopRequested) {
            log(`→ Depth ${depth+1} (${next.length} new bases)`, 'info');
            await bruteForce(next, depth+1, maxDepth, limiter);
        }
    }

    function updateProgress() {
        const pct = totalChecks ? Math.floor((completedChecks / totalChecks) * 100) : 0;
        document.getElementById('progressBar').style.width = pct + '%';
        document.getElementById('progressPercent').textContent = pct + '%';
        document.getElementById('checksDone').textContent = completedChecks;
        document.getElementById('checksTotal').textContent = totalChecks;
        document.getElementById('currentDepth').textContent = currentDepth;
    }

    async function startScan() {
        if (isRunning) return;
        let target = document.getElementById('target').value.trim().toLowerCase();
        if (!target.includes('.')) return alert('Enter a valid domain');

        resetScan();
        const useSmartPSL = document.getElementById('usePSL').checked;
        const baseDomain = useSmartPSL ? getRegistrableDomain(target) : target;

        log(`Target: ${target}`, 'info');
        log(`Detected registrable base: ${baseDomain}`, 'success');

        const concurrency = parseInt(document.getElementById('concurrency').value);
        const maxD = parseInt(document.getElementById('maxDepth').value);
        const limiter = createLimiter(concurrency);

        document.getElementById('progressSection').classList.remove('hidden');

        // === ROOT DOMAIN ENUMERATION (depth 0) ===
        log('Enumerating root domain...', 'info');
        const rootRes = await resolveSubdomain(target);
        addResult(target, rootRes, 0);

        // === SUBDOMAIN BRUTE FORCE on base ===
        if (target !== baseDomain) log(`Brute-forcing subs on base: ${baseDomain}`, 'info');
        await bruteForce([baseDomain], 1, maxD, limiter);

        finishScan();
    }

    function resetScan() {
        isRunning = true; stopRequested = false;
        results = []; discovered = new Set();
        providerStats = {}; totalQueries = 0; totalSuccess = 0;
        resolutionHistory = [];
        totalChecks = completedChecks = 0;
        resultsBody.innerHTML = ''; logEl.innerHTML = '';
        trafficParticles = [];
        document.getElementById('startBtn').classList.add('opacity-50','cursor-not-allowed');
        document.getElementById('stopBtn').classList.remove('hidden');
    }

    function finishScan() {
        isRunning = false;
        document.getElementById('startBtn').classList.remove('opacity-50','cursor-not-allowed');
        document.getElementById('stopBtn').classList.add('hidden');
        document.getElementById('progressSection').classList.add('hidden');
        log('✅ Scan completed! Root domain + subs enumerated', 'success');
    }

    function stopScan() { stopRequested = true; log('⏹ Stop requested', 'error'); }

    function clearResults() {
        if (confirm('Clear all?')) {
            results = []; discovered = new Set();
            resultsBody.innerHTML = '';
            providerStats = {}; totalQueries = totalSuccess = 0;
        }
    }

    function exportCSV() {
        if (!results.length) return alert('No results');
        let csv = 'Subdomain,IPs,CNAME,Other,Depth\n';
        results.forEach(r => csv += `"${r.subdomain}","${r.ips.join('; ')}","${r.cname || ''}","${r.other || ''}",${r.depth}\n`);
        const blob = new Blob([csv], {type:'text/csv'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `subenum-${document.getElementById('target').value}.csv`;
        a.click();
    }

    function initUI() {
        const pDiv = document.getElementById('providerCheckboxes');
        defaultProviders.forEach((p,i) => {
            pDiv.innerHTML += `<label class="pill flex items-center gap-2 bg-zinc-800 px-4 py-3 rounded-3xl cursor-pointer"><input type="checkbox" ${p.checked?'checked':''} onchange="defaultProviders[${i}].checked=this.checked" class="accent-violet-500"><span>${p.name}</span></label>`;
        });

        const rDiv = document.getElementById('recordTypeCheckboxes');
        recordTypeList.forEach(r => {
            rDiv.innerHTML += `<label class="pill flex items-center gap-2 bg-zinc-800 px-4 py-3 rounded-3xl cursor-pointer"><input type="checkbox" value="${r.value}" ${r.checked?'checked':''} class="accent-violet-500"><span>${r.label}</span></label>`;
        });

        document.getElementById('concurrency').addEventListener('input', e => document.getElementById('concurrencyValue').textContent = e.target.value);
    }

    function showTab(n) {
        document.querySelectorAll('[id^="tabContent"]').forEach(el => el.classList.add('hidden'));
        document.getElementById('tabContent'+n).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active','bg-zinc-800'));
        document.getElementById('tab'+n).classList.add('active','bg-zinc-800');
        if (n === 2) { updateDashboard(); if (!animationFrame) startTrafficAnimation(); }
    }

    function addCustomProvider() {
        const url = document.getElementById('customDoh').value.trim();
        if (!url) return;
        customProviders.push({name: url.split('//')[1]?.split('/')[0] || 'Custom', url});
        renderCustomProviders();
        document.getElementById('customDoh').value = '';
    }

    function renderCustomProviders() {
        document.getElementById('customProvidersList').innerHTML = customProviders.map((p,i) => `
            <div class="flex justify-between bg-zinc-800 rounded-2xl px-4 py-2 text-xs"><span class="font-mono">${p.url}</span><button onclick="removeCustom(${i})" class="text-red-400">×</button></div>
        `).join('');
    }

    function removeCustom(i) { customProviders.splice(i,1); renderCustomProviders(); }

    function uploadWordlist() { document.getElementById('wordlistUpload').click(); }
    function handleFileUpload(e) {
        const reader = new FileReader();
        reader.onload = ev => {
            document.getElementById('wordlist').value = ev.target.result;
            log(`Wordlist loaded: ${e.target.files[0].name}`, 'success');
        };
        reader.readAsText(e.target.files[0]);
    }

    window.onload = () => {
        initUI();
        initTrafficCanvas();
        initCharts();
        showTab(0);
        log('SubEnum v4.2 ready • Root domain always enumerated • Smart PSL active', 'success');
        log('Tip: Enable PSL for accurate gov.uk / co.uk handling', 'info');

        setInterval(() => {
            if (isRunning || !document.getElementById('tabContent2').classList.contains('hidden')) updateDashboard();
        }, 800);
    };
</script>
</body>
</html>

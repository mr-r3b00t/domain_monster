<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SubEnum v4.4.1 ‚Ä¢ Fixed Enumeration</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap');
        body { font-family: 'Space Grotesk', sans-serif; }
        .log-line { font-family: ui-monospace, monospace; }
        .pill { transition: all 0.2s cubic-bezier(0.4,0,0.2,1); }
        .pill:hover { transform: translateY(-2px) scale(1.03); }
        #trafficCanvas { background: #18181b; border-radius: 16px; }
    </style>
</head>
<body class="bg-zinc-950 text-zinc-200">
<div class="min-h-screen flex">
    <!-- Sidebar -->
    <div class="w-80 bg-zinc-900 border-r border-zinc-800 p-4 flex flex-col overflow-y-auto">
        <div class="flex items-center gap-2 mb-3">
            <div class="w-8 h-8 bg-gradient-to-br from-violet-500 to-fuchsia-500 rounded-2xl flex items-center justify-center text-black font-black text-lg">S</div>
            <div>
                <h1 class="text-xl font-bold tracking-tighter">SubEnum <span class="text-[10px] text-violet-400 align-super">v4.4.1</span></h1>
                <p class="text-[10px] text-zinc-500 -mt-0.5">Fixed subdomain enumeration</p>
            </div>
        </div>

        <div class="space-y-3">
            <div>
                <label class="block text-[10px] font-medium text-zinc-400 mb-1">TARGET DOMAIN</label>
                <input id="target" type="text" value="pwndefend.com" class="w-full bg-zinc-800 border border-zinc-700 rounded-2xl px-3 py-2 text-sm focus:outline-none focus:border-violet-500">
            </div>

            <div>
                <label class="block text-[10px] font-medium text-zinc-400 mb-1.5">DNS PROVIDERS</label>
                <div id="providerCheckboxes" class="grid grid-cols-2 gap-1.5"></div>
                <div class="mt-2 flex gap-2">
                    <input id="customDoh" placeholder="https://doh.example.com/dns-query" class="flex-1 bg-zinc-800 border border-zinc-700 rounded-2xl px-3 py-1.5 text-[11px] font-mono">
                    <button onclick="addCustomProvider()" class="bg-zinc-800 hover:bg-zinc-700 px-3 rounded-2xl text-[10px] font-medium">ADD</button>
                </div>
                <div id="customProvidersList" class="mt-2 space-y-1 text-[10px]"></div>
            </div>

            <div>
                <div class="flex justify-between items-center mb-1">
                    <label class="block text-[10px] font-medium text-zinc-400">WORDLIST</label>
                    <button onclick="uploadWordlist()" class="text-[9px] px-2 py-0.5 bg-zinc-800 hover:bg-zinc-700 rounded-lg flex items-center gap-1"><i class="fa-solid fa-upload text-[8px]"></i> Upload</button>
                </div>
                <textarea id="wordlist" rows="3" class="w-full bg-zinc-800 border border-zinc-700 rounded-2xl p-2 text-[11px] font-mono resize-none focus:outline-none focus:border-violet-500 leading-tight">www
api
admin
dev
test
staging
prod
beta
demo
shop
blog
app
mobile
login
portal
dashboard
cdn
static
assets
media</textarea>
            </div>

            <div>
                <label class="block text-[10px] font-medium text-zinc-400 mb-1.5">RECORD TYPES</label>
                <div id="recordTypeCheckboxes" class="grid grid-cols-4 gap-1"></div>
            </div>

            <div>
                <label class="block text-[10px] font-medium text-zinc-400 mb-1">PSL</label>
                <div class="flex items-center gap-2 bg-zinc-800 rounded-2xl p-2">
                    <input type="checkbox" id="usePSL" checked class="accent-violet-500 w-3 h-3">
                    <div class="text-[10px]">Smart detection <span class="text-zinc-500">(gov.uk, co.uk)</span></div>
                </div>
                <button onclick="loadFullPSL()" class="mt-1.5 w-full bg-zinc-800 hover:bg-zinc-700 py-1.5 rounded-2xl text-[10px] font-medium flex items-center justify-center gap-1.5"><i class="fa-solid fa-globe text-[9px]"></i> Load Full PSL</button>
                <div id="pslStatus" class="text-[9px] text-emerald-400 mt-0.5 text-center">Built-in PSL active</div>
            </div>

            <div id="wildcardStatus" class="hidden bg-amber-500/10 border border-amber-500/50 rounded-2xl p-2">
                <div class="flex items-center gap-2 text-amber-400">
                    <i class="fa-solid fa-triangle-exclamation text-sm"></i>
                    <div><div class="font-semibold text-[10px]">WILDCARD</div><div id="wildcardDetail" class="text-[9px]">Random subs resolve</div></div>
                </div>
            </div>

            <div class="flex items-center gap-2 bg-zinc-800 rounded-2xl p-2">
                <input type="checkbox" id="debugEnabled" class="accent-violet-500 w-3 h-3">
                <div class="text-[10px]">Debug logging <span class="text-zinc-500">(DEBUG tab)</span></div>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-[9px] text-zinc-400 mb-0.5">CONCURRENCY</label>
                    <input id="concurrency" type="range" min="5" max="100" value="25" class="w-full accent-violet-500">
                    <div id="concurrencyValue" class="text-center text-[10px] font-mono text-violet-400">25</div>
                </div>
                <div>
                    <label class="block text-[9px] text-zinc-400 mb-0.5">DEPTH</label>
                    <select id="maxDepth" class="w-full bg-zinc-800 border border-zinc-700 rounded-2xl px-2 py-1.5 text-[11px]">
                        <option value="1">1</option>
                        <option value="2" selected>2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                    </select>
                </div>
            </div>

            <button onclick="startScan()" id="startBtn" class="w-full bg-violet-600 hover:bg-violet-500 py-2.5 rounded-2xl font-semibold text-sm flex items-center justify-center gap-2"><i class="fa-solid fa-bolt"></i> START</button>
            <button onclick="stopScan()" id="stopBtn" class="w-full py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded-2xl hidden font-medium text-sm">STOP</button>
        </div>
    </div>

    <!-- Main -->
    <div class="flex-1 flex flex-col">
        <div class="border-b border-zinc-800 px-4 py-2.5 flex items-center justify-between bg-zinc-900">
            <div class="flex gap-3">
                <button onclick="showTab(0)" id="tab0" class="tab-btn active px-4 py-1.5 rounded-2xl text-[11px] font-medium">RESULTS</button>
                <button onclick="showTab(1)" id="tab1" class="tab-btn px-4 py-1.5 rounded-2xl text-[11px] font-medium">LOG</button>
                <button onclick="showTab(3)" id="debugTabBtn" class="tab-btn px-4 py-1.5 rounded-2xl text-[11px] font-medium hidden">DEBUG</button>
                <button onclick="showTab(2)" id="tab2" class="tab-btn px-4 py-1.5 rounded-2xl text-[11px] font-medium">DASH</button>
            </div>
            <div class="flex gap-2">
                <button onclick="clearResults()" class="px-3 py-1 text-[10px] border border-zinc-700 rounded-2xl hover:bg-zinc-800">CLEAR</button>
                <button onclick="exportCSV()" class="px-3 py-1 text-[10px] bg-zinc-800 hover:bg-zinc-700 rounded-2xl">CSV</button>
            </div>
        </div>

        <div id="tabContent0" class="flex-1 overflow-auto p-3">
            <div class="flex justify-between items-center mb-2">
                <div class="text-[10px] text-zinc-400">
                    <span id="resultsCount">0 results</span>
                    <span class="ml-3 text-zinc-600">Use ‚Üê ‚Üí to navigate</span>
                </div>
                <div id="paginationControls" class="flex items-center gap-2">
                    <button onclick="changePage(-1)" class="px-2 py-1 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-[10px] disabled:opacity-30 disabled:cursor-not-allowed" id="prevPage">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                    <span class="text-[10px] text-zinc-400 font-mono">
                        Page <span id="currentPageDisplay">1</span> of <span id="totalPagesDisplay">1</span>
                    </span>
                    <button onclick="changePage(1)" class="px-2 py-1 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-[10px] disabled:opacity-30 disabled:cursor-not-allowed" id="nextPage">
                        <i class="fa-solid fa-chevron-right"></i>
                    </button>
                    <select id="perPageSelect" onchange="changePerPage()" class="ml-2 bg-zinc-800 border border-zinc-700 rounded-lg px-2 py-1 text-[10px]">
                        <option value="25">25/page</option>
                        <option value="50" selected>50/page</option>
                        <option value="100">100/page</option>
                        <option value="500">500/page</option>
                    </select>
                </div>
            </div>
            <table class="w-full">
                <thead class="bg-zinc-900 sticky top-0 z-10">
                    <tr class="text-[10px] text-zinc-400 border-b border-zinc-800">
                        <th class="py-2 px-3 text-left">#</th>
                        <th class="py-2 px-3 text-left">SUBDOMAIN</th>
                        <th class="py-2 px-3 text-left">IPs</th>
                        <th class="py-2 px-3 text-left">CNAME</th>
                        <th class="py-2 px-3 text-left">OTHER</th>
                        <th class="py-2 px-3 text-left">D</th>
                        <th class="py-2 px-3 w-10"></th>
                    </tr>
                </thead>
                <tbody id="resultsBody" class="text-[11px] divide-y divide-zinc-800"></tbody>
            </table>
        </div>

        <div id="tabContent1" class="flex-1 overflow-auto p-3 hidden bg-black">
            <div id="log" class="font-mono text-[10px] text-zinc-300 space-y-0.5 h-full overflow-auto"></div>
        </div>

        <div id="tabContent3" class="flex-1 overflow-auto p-3 hidden bg-black">
            <div id="debugLog" class="font-mono text-[10px] text-sky-300 space-y-0.5 h-full overflow-auto"></div>
        </div>

        <div id="tabContent2" class="flex-1 overflow-auto p-3 hidden bg-zinc-950">
            <div class="max-w-7xl mx-auto space-y-3">
                <div class="grid grid-cols-4 gap-2">
                    <div class="bg-zinc-900 rounded-2xl p-2.5">
                        <div class="text-[9px] text-zinc-500">QUERIES</div>
                        <div id="statQueries" class="text-2xl font-bold text-white mt-0.5 font-mono">0</div>
                    </div>
                    <div class="bg-zinc-900 rounded-2xl p-2.5">
                        <div class="text-[9px] text-zinc-500">SUCCESS</div>
                        <div id="statSuccess" class="text-2xl font-bold text-emerald-400 mt-0.5 font-mono">0</div>
                    </div>
                    <div class="bg-zinc-900 rounded-2xl p-2.5">
                        <div class="text-[9px] text-zinc-500">RATE</div>
                        <div id="statRate" class="text-2xl font-bold text-amber-400 mt-0.5 font-mono">0/s</div>
                    </div>
                    <div class="bg-zinc-900 rounded-2xl p-2.5">
                        <div class="text-[9px] text-zinc-500">SUCCESS %</div>
                        <div id="statSuccessPct" class="text-2xl font-bold text-sky-400 mt-0.5 font-mono">0%</div>
                    </div>
                </div>

                <div>
                    <div class="text-[10px] font-medium text-zinc-400 mb-1.5">DNS PROVIDERS LIVE</div>
                    <div id="providersGrid" class="grid grid-cols-3 gap-2"></div>
                </div>

                <div>
                    <div class="text-[10px] font-medium text-zinc-400 mb-1.5 flex items-center gap-2">
                        TRAFFIC FLOW
                        <div class="flex-1 h-px bg-zinc-800"></div>
                    </div>
                    <canvas id="trafficCanvas" width="1100" height="150" class="w-full"></canvas>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-zinc-900 rounded-2xl p-2.5">
                        <div class="text-[10px] font-medium text-zinc-400 mb-1.5">RESOLUTIONS</div>
                        <canvas id="lineChart" height="90"></canvas>
                    </div>
                    <div class="bg-zinc-900 rounded-2xl p-2.5">
                        <div class="text-[10px] font-medium text-zinc-400 mb-1.5">REQUESTS/PROVIDER</div>
                        <canvas id="barChart" height="90"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Section -->
        <div id="progressSection" class="hidden border-t border-zinc-800 bg-zinc-900 px-4 py-2">
            <div class="flex items-center gap-3">
                <div class="flex-1">
                    <div class="flex justify-between text-[10px] text-zinc-400 mb-1">
                        <span><span id="progressPercent">0%</span></span>
                        <span>D:<span id="currentDepth">0</span></span>
                        <span><span id="checksDone">0</span>/<span id="checksTotal">0</span></span>
                    </div>
                    <div class="w-full h-1.5 bg-zinc-800 rounded-full overflow-hidden">
                        <div id="progressBar" class="h-full bg-gradient-to-r from-violet-500 to-fuchsia-500 transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="border-t border-zinc-800 bg-zinc-900 px-4 py-2 text-[10px] text-zinc-500 flex justify-between">
            <div>v4.4.1</div>
            <div id="status" class="font-mono">Ready</div>
        </div>
    </div>
</div>

<input type="file" id="wordlistUpload" accept=".txt" class="hidden" onchange="handleFileUpload(event)">

<script>
    // === PSL ===
    let psl = new Set(["com","net","org","edu","gov","mil","int","uk","co.uk","org.uk","gov.uk","ac.uk","me.uk","net.uk","nhs.uk","police.uk","sch.uk","ca","de","fr","it","jp","au","com.au","net.au","org.au","us","co","io","me","biz","info","name","pro","xyz","top","site","online","club","app","dev","cloud","ai","tech","shop","blog","news","tv","fm","cc","gg","sh","to","ws","nu","ac","eu","ch","nl","se","no","dk","fi","be","at","es","pt","gr","pl","cz","hu","ro","sk","si","hr","bg","ee","lt","lv","lu","mt","cy","is","ru","cn","tw","hk","in","br","mx","ar","cl","za","ng","ke","eg","tr","il","ae","sa","kr","vn","th","my","sg","id","ph","nz","pk"]);

    async function loadFullPSL() {
        const status = document.getElementById('pslStatus');
        status.textContent = 'Loading...';
        try {
            const r = await fetch('https://raw.githubusercontent.com/publicsuffix/list/master/public_suffix_list.dat');
            const txt = await r.text();
            psl.clear();
            txt.split('\n').forEach(l => {
                l = l.trim();
                if (l && !l.startsWith('//') && !l.startsWith('!')) psl.add(l.toLowerCase());
            });
            status.textContent = `PSL loaded (${psl.size})`;
            log('Full PSL loaded', 'success');
        } catch(e) {
            status.textContent = 'Failed';
            log('PSL load failed: ' + e.message, 'error');
        }
    }

    function getRegistrableDomain(d) {
        const lower = d.toLowerCase();
        const labels = lower.split('.');
        if (labels.length < 2) return d;
        let suffix = '';
        for (let i = 1; i <= Math.min(4, labels.length); i++) {
            const cand = labels.slice(-i).join('.');
            if (psl.has(cand)) { suffix = cand; break; }
        }
        if (!suffix) return d;
        const sp = suffix.split('.').length;
        return labels.slice(Math.max(0, labels.length - sp - 1)).join('.');
    }

    // === WILDCARD ===
    let isWildcard = false;
    let wildcardTestDomains = new Set();

    async function performWildcardCheck(base) {
        log('üîç Wildcard check...', 'info');
        wildcardTestDomains.clear();
        const tests = [];
        for (let i = 0; i < 3; i++) {
            const randomSub = Math.random().toString(36).substring(2,14) + '.' + base;
            tests.push(randomSub);
            wildcardTestDomains.add(randomSub);
        }
        let detected = false;
        for (const t of tests) {
            const r = await resolveSubdomainRaw(t);
            if (r.ips.length || r.cname || r.other) { detected = true; break; }
        }
        isWildcard = detected;
        const banner = document.getElementById('wildcardStatus');
        if (detected) {
            banner.classList.remove('hidden');
            document.getElementById('wildcardDetail').textContent = `*.${base}`;
            log(`‚ö†Ô∏è WILDCARD`, 'error');
        } else {
            banner.classList.add('hidden');
            log('‚úÖ No wildcard', 'success');
        }
    }

    // === LOGGING ===
    let debugEnabled = false;
    function debugLog(msg) {
        if (!debugEnabled) return;
        const t = new Date().toLocaleTimeString('en-US',{hour12:false});
        document.getElementById('debugLog').innerHTML += `<div class="log-line text-sky-300">[${t}] ${msg}</div>`;
        document.getElementById('debugLog').scrollTop = document.getElementById('debugLog').scrollHeight;
    }

    function log(msg, type='info') {
        const t = new Date().toLocaleTimeString('en-US',{hour12:false});
        const cls = type==='success'?'text-emerald-400':type==='error'?'text-red-400':'text-zinc-400';
        document.getElementById('log').innerHTML += `<div class="log-line ${cls}">[${t}] ${msg}</div>`;
        document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
    }

    // === CORE ===
    let defaultProviders = [
        {id:"cloudflare",name:"Cloudflare",url:"https://cloudflare-dns.com/dns-query",checked:true},
        {id:"google",name:"Google",url:"https://dns.google/resolve",checked:true},
        {id:"quad9",name:"Quad9",url:"https://dns.quad9.net/dns-query",checked:false},
        {id:"adguard",name:"AdGuard",url:"https://dns.adguard.com/dns-query",checked:false}
    ];
    let customProviders = [];
    let providerIndex = 0;

    const recordTypeList = [
        {value:"A",label:"A",checked:true},{value:"AAAA",label:"AAAA",checked:true},
        {value:"CNAME",label:"CNAME",checked:true},{value:"MX",label:"MX",checked:false},
        {value:"NS",label:"NS",checked:false},{value:"TXT",label:"TXT",checked:false},
        {value:"SRV",label:"SRV",checked:false}
    ];

    let providerStats = {};
    let totalQueries = 0, totalSuccess = 0, lastSecondQueries = 0, rate = 0;
    let resolutionHistory = [];
    let lineChart, barChart;
    let isRunning = false, stopRequested = false;
    let results = [], discovered = new Set();
    let totalChecks = 0, completedChecks = 0, currentDepth = 0;
    let trafficCtx, trafficParticles = [], animationFrame;
    
    // Pagination
    let currentPage = 1;
    let resultsPerPage = 50;

    function getSelectedProviders() { 
        const selected = [...defaultProviders.filter(p=>p.checked), ...customProviders];
        if (selected.length === 0) {
            log('‚ö†Ô∏è No providers, using Cloudflare', 'error');
            return [defaultProviders[0]];
        }
        return selected;
    }

    function getNextDoHUrl() {
        const list = getSelectedProviders();
        const p = list[providerIndex % list.length];
        providerIndex = (providerIndex + 1) % list.length;
        return {url:p.url, name:p.name};
    }

    async function resolveSubdomainRaw(sub) {
        const types = Array.from(document.querySelectorAll('#recordTypeCheckboxes input:checked')).map(c=>c.value);
        const result = {ips:[], cname:null, other:''};
        const {url, name} = getNextDoHUrl();

        if (!providerStats[name]) providerStats[name] = {requests:0, successes:0};
        providerStats[name].requests++;
        totalQueries++;

        debugLog(`QUERY ‚Üí ${name} | ${sub} | ${types.join(',')}`);

        for (const type of types) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const r = await fetch(`${url}?name=${encodeURIComponent(sub)}&type=${type}`, {
                    headers:{'Accept':'application/dns-json'},
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                if (!r.ok) {
                    debugLog(`ERROR ‚Üê ${name} | HTTP ${r.status}`);
                    continue;
                }
                const d = await r.json();
                if (!d.Answer) continue;
                d.Answer.forEach(a => {
                    if ((type==='A' && a.type===1) || (type==='AAAA' && a.type===28)) result.ips.push(a.data);
                    if (type==='CNAME' && a.type===5) result.cname = a.data;
                    if (['MX','NS','TXT','SRV'].includes(type) && a.data) result.other += (result.other?', ':'') + `${type}:${a.data}`;
                });
            } catch(e){
                if (e.name === 'AbortError') {
                    debugLog(`TIMEOUT ‚Üê ${name} | ${sub}`);
                } else {
                    debugLog(`ERROR ‚Üê ${name} | ${e.message}`);
                }
            }
        }

        result.ips = [...new Set(result.ips)];
        const success = result.ips.length || result.cname || result.other;
        if (success) { providerStats[name].successes++; totalSuccess++; }

        debugLog(`RESULT ‚Üê ${sub} | ${success} | ${result.ips.length}`);

        return result;
    }

    async function resolveSubdomain(sub) {
        const result = await resolveSubdomainRaw(sub);
        
        if (!document.getElementById('tabContent2').classList.contains('hidden')) {
            const success = result.ips.length || result.cname || result.other;
            const providers = getSelectedProviders();
            const providerName = Object.keys(providerStats)[Object.keys(providerStats).length - 1] || 'Unknown';
            trafficParticles.push({
                x:80,
                y:75,
                targetX:520+(providers.findIndex(p=>p.name===providerName)*180),
                progress:0,
                success:success,
                color:success?'#10b981':'#ef4444'
            });
        }
        
        return result;
    }

    function initTrafficCanvas() { trafficCtx = document.getElementById('trafficCanvas').getContext('2d'); }
    
    function drawTraffic() {
        trafficCtx.clearRect(0,0,1100,150);
        trafficCtx.fillStyle = '#a855f7'; trafficCtx.beginPath(); trafficCtx.arc(80,75,24,0,Math.PI*2); trafficCtx.fill();
        trafficCtx.fillStyle = '#fff'; trafficCtx.font = 'bold 11px monospace'; trafficCtx.textAlign='center'; trafficCtx.fillText('YOU',80,80);
        getSelectedProviders().forEach((p,i) => {
            const x = 520 + i*180;
            trafficCtx.fillStyle = '#64748b'; trafficCtx.beginPath(); trafficCtx.arc(x,75,22,0,Math.PI*2); trafficCtx.fill();
            trafficCtx.fillStyle = '#e0f2fe'; trafficCtx.font = '10px monospace'; trafficCtx.fillText(p.name.slice(0,8),x,79);
        });
        for (let i=trafficParticles.length-1; i>=0; i--) {
            const p = trafficParticles[i];
            p.progress += 0.028;
            const x = p.x + (p.targetX - p.x) * p.progress;
            const y = 75 + Math.sin(p.progress * Math.PI * 2) * 10;
            trafficCtx.fillStyle = p.color;
            trafficCtx.beginPath(); trafficCtx.arc(x,y,5,0,Math.PI*2); trafficCtx.fill();
            if (p.progress >= 1) trafficParticles.splice(i,1);
        }
    }
    
    function startTrafficAnimation() {
        if (animationFrame) cancelAnimationFrame(animationFrame);
        function loop() { drawTraffic(); animationFrame = requestAnimationFrame(loop); }
        loop();
    }
    
    function stopTrafficAnimation() {
        if (animationFrame) {
            cancelAnimationFrame(animationFrame);
            animationFrame = null;
        }
    }

    function initCharts() {
        lineChart = new Chart(document.getElementById('lineChart'), {type:'line',data:{labels:[],datasets:[{label:'Success',borderColor:'#22d3ee',tension:0.4,data:[]}]},options:{plugins:{legend:{display:false}},scales:{y:{grid:{color:'#27272a'}}}}});
        barChart = new Chart(document.getElementById('barChart'), {type:'bar',data:{labels:[],datasets:[{label:'Requests',backgroundColor:'#8b5cf6',data:[]}]},options:{plugins:{legend:{display:false}},scales:{y:{grid:{color:'#27272a'}}}}});
    }
    
    function updateCharts() {
        const now = new Date().toLocaleTimeString([],{minute:'2-digit',second:'2-digit'});
        resolutionHistory.push({time:now,count:totalSuccess});
        if (resolutionHistory.length > 20) resolutionHistory.shift();
        lineChart.data.labels = resolutionHistory.map(h=>h.time);
        lineChart.data.datasets[0].data = resolutionHistory.map(h=>h.count);
        lineChart.update('none');

        const labels = Object.keys(providerStats);
        barChart.data.labels = labels;
        barChart.data.datasets[0].data = labels.map(n=>providerStats[n].requests);
        barChart.update('none');
    }

    function updateDashboard() {
        document.getElementById('statQueries').textContent = totalQueries;
        document.getElementById('statSuccess').textContent = totalSuccess;
        document.getElementById('statSuccessPct').textContent = totalQueries ? Math.round((totalSuccess/totalQueries)*100)+'%' : '0%';
        const now = Date.now();
        if (now - (window.lastRateTime||0) > 1000) {
            rate = totalQueries - lastSecondQueries;
            lastSecondQueries = totalQueries;
            window.lastRateTime = now;
        }
        document.getElementById('statRate').textContent = rate + '/s';

        const grid = document.getElementById('providersGrid');
        grid.innerHTML = getSelectedProviders().map(p => {
            const s = providerStats[p.name] || {requests:0,successes:0};
            const pct = s.requests ? Math.round((s.successes/s.requests)*100) : 0;
            return `<div class="bg-zinc-900 rounded-2xl p-2.5 border border-zinc-800"><div class="flex justify-between items-start mb-2"><div><div class="font-semibold text-[11px]">${p.name}</div><div class="text-[9px] text-zinc-500">${p.url.split('//')[1].split('/')[0]}</div></div><div class="text-right"><div class="text-xl font-mono text-emerald-400">${s.successes}</div></div></div><div class="h-1.5 bg-zinc-800 rounded-full overflow-hidden"><div class="h-full bg-gradient-to-r from-emerald-400 to-cyan-400" style="width:${pct}%"></div></div><div class="flex justify-between text-[9px] mt-1"><span class="font-mono">${s.requests} req</span><span class="text-emerald-400">${pct}%</span></div></div>`;
        }).join('');
        updateCharts();
    }

    function createLimiter(max) {
        let running = 0, queue = [];
        return async task => {
            if (running >= max) await new Promise(r => queue.push(r));
            running++;
            try { await task(); }
            finally { running--; if (queue.length) queue.shift()(); }
        };
    }

    function addResult(sub, res, depth) {
        if (!res.ips.length && !res.cname && !res.other) return;
        results.push({subdomain:sub, ips:res.ips, cname:res.cname, other:res.other, depth});
        
        // If scanning, jump to last page to show latest results
        if (isRunning) {
            const totalPages = Math.ceil(results.length / resultsPerPage);
            currentPage = totalPages;
        }
        
        renderResults();
    }

    function renderResults() {
        const totalPages = Math.ceil(results.length / resultsPerPage);
        
        // Ensure current page is valid
        if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;
        
        // Calculate pagination
        const startIdx = (currentPage - 1) * resultsPerPage;
        const endIdx = Math.min(startIdx + resultsPerPage, results.length);
        const pageResults = results.slice(startIdx, endIdx);
        
        // Render table rows
        document.getElementById('resultsBody').innerHTML = pageResults.map((r,i) => `
            <tr class="hover:bg-zinc-800/50">
                <td class="py-1.5 px-3 text-zinc-500">${startIdx + i + 1}</td>
                <td class="py-1.5 px-3 font-medium text-violet-300">${r.subdomain}</td>
                <td class="py-1.5 px-3 text-[10px] font-mono">${r.ips.join('<br>')||'‚Äî'}</td>
                <td class="py-1.5 px-3 text-[10px] font-mono text-amber-300">${r.cname||'‚Äî'}</td>
                <td class="py-1.5 px-3 text-[10px] font-mono text-sky-300">${r.other||'‚Äî'}</td>
                <td class="py-1.5 px-3"><span class="px-1.5 py-0.5 bg-zinc-800 rounded-full text-[9px]">${r.depth}</span></td>
                <td class="py-1.5 px-3"><a href="https://${r.subdomain}" target="_blank" class="text-violet-400 text-[10px]"><i class="fa-solid fa-external-link-alt"></i></a></td>
            </tr>
        `).join('');
        
        // Update pagination controls
        document.getElementById('resultsCount').textContent = `${results.length} result${results.length !== 1 ? 's' : ''}`;
        document.getElementById('currentPageDisplay').textContent = totalPages > 0 ? currentPage : 0;
        document.getElementById('totalPagesDisplay').textContent = totalPages;
        
        // Enable/disable pagination buttons
        document.getElementById('prevPage').disabled = currentPage <= 1;
        document.getElementById('nextPage').disabled = currentPage >= totalPages;
        
        // Show/hide pagination controls
        document.getElementById('paginationControls').style.display = results.length > 0 ? 'flex' : 'none';
    }
    
    function changePage(delta) {
        currentPage += delta;
        renderResults();
        // Scroll to top of results
        document.getElementById('tabContent0').scrollTop = 0;
    }
    
    function changePerPage() {
        resultsPerPage = parseInt(document.getElementById('perPageSelect').value);
        currentPage = 1;
        renderResults();
    }

    function calculateTotalChecks(bases, depth, maxDepth, wordlistSize) {
        if (depth > maxDepth) return 0;
        let total = bases.length * wordlistSize;
        if (depth < maxDepth) {
            total += calculateTotalChecks(bases.map(() => wordlistSize).flat(), depth + 1, maxDepth, wordlistSize);
        }
        return total;
    }

    async function bruteForce(bases, depth, maxDepth, limiter, wordlistSize) {
        if (depth > maxDepth || stopRequested) return;
        currentDepth = depth;
        const words = document.getElementById('wordlist').value.trim().split('\n').map(w => w.trim()).filter(Boolean);
        log(`D${depth}: ${words.length} √ó ${bases.length}`, 'info');
        debugLog(`BF depth:${depth} words:${words.length} bases:${bases.length}`);

        const next = [];
        for (const base of bases) {
            for (const word of words) {
                if (stopRequested) break;
                const sub = `${word}.${base}`;
                
                if (discovered.has(sub) || wildcardTestDomains.has(sub)) {
                    completedChecks++;
                    updateProgress();
                    continue;
                }
                
                discovered.add(sub);

                completedChecks++;
                updateProgress();

                const task = async () => {
                    const res = await resolveSubdomain(sub);
                    if (res.ips.length || res.cname || res.other) {
                        log(`‚úì ${sub}`, 'success');
                        addResult(sub, res, depth);
                        next.push(sub);
                    }
                };
                await limiter(task);
            }
        }
        
        if (next.length && depth < maxDepth && !stopRequested) {
            log(`‚Üí D${depth+1} (${next.length})`, 'info');
            await bruteForce(next, depth+1, maxDepth, limiter, wordlistSize);
        }
    }

    function updateProgress() {
        const pct = totalChecks ? Math.floor((completedChecks / totalChecks) * 100) : 0;
        document.getElementById('progressBar').style.width = pct + '%';
        document.getElementById('progressPercent').textContent = pct + '%';
        document.getElementById('checksDone').textContent = completedChecks;
        document.getElementById('checksTotal').textContent = totalChecks;
        document.getElementById('currentDepth').textContent = currentDepth;
    }

    async function startScan() {
        if (isRunning) return;
        let target = document.getElementById('target').value.trim().toLowerCase();
        if (!target.includes('.')) return alert('Enter a valid domain');

        resetScan();
        debugEnabled = document.getElementById('debugEnabled').checked;

        const usePSL = document.getElementById('usePSL').checked;
        const base = usePSL ? getRegistrableDomain(target) : target;

        log(`Target: ${target}`, 'info');
        log(`Base: ${base}`, 'success');
        debugLog(`=== START === ${target} | ${base}`);

        await performWildcardCheck(base);

        log('Root enum...', 'info');
        const rootRes = await resolveSubdomain(target);
        addResult(target, rootRes, 0);

        const conc = parseInt(document.getElementById('concurrency').value);
        const maxD = parseInt(document.getElementById('maxDepth').value);
        const limiter = createLimiter(conc);
        
        const wordlistSize = document.getElementById('wordlist').value.trim().split('\n').filter(Boolean).length;
        totalChecks = wordlistSize;
        if (maxD > 1) {
            totalChecks += Math.floor(wordlistSize * wordlistSize * 0.1 * (maxD - 1));
        }

        document.getElementById('progressSection').classList.remove('hidden');

        log(`Starting on ${base}...`, 'info');
        await bruteForce([base], 1, maxD, limiter, wordlistSize);

        finishScan();
    }

    function resetScan() {
        isRunning = true; stopRequested = false;
        results = []; discovered = new Set();
        currentPage = 1; // Reset pagination
        providerStats = {}; totalQueries = 0; totalSuccess = 0;
        resolutionHistory = [];
        totalChecks = completedChecks = 0;
        document.getElementById('wildcardStatus').classList.add('hidden');
        document.getElementById('debugLog').innerHTML = '';
        document.getElementById('log').innerHTML = '';
        document.getElementById('resultsBody').innerHTML = '';
        trafficParticles = [];
        document.getElementById('startBtn').classList.add('opacity-50','cursor-not-allowed');
        document.getElementById('stopBtn').classList.remove('hidden');
        document.getElementById('progressSection').classList.add('hidden');
        renderResults(); // Update pagination display
    }

    function finishScan() {
        isRunning = false;
        document.getElementById('startBtn').classList.remove('opacity-50','cursor-not-allowed');
        document.getElementById('stopBtn').classList.add('hidden');
        document.getElementById('progressSection').classList.add('hidden');
        log('‚úÖ Complete!', 'success');
        debugLog('=== DONE ===');
    }

    function stopScan() { 
        stopRequested = true; 
        log('‚èπ Stopping', 'error'); 
        debugLog('STOP'); 
    }

    function clearResults() {
        if (confirm('Clear results?')) {
            results = []; 
            discovered = new Set();
            currentPage = 1;
            document.getElementById('resultsBody').innerHTML = '';
            renderResults(); // Update pagination display
            log('Cleared', 'info');
        }
    }

    function exportCSV() {
        if (!results.length) return alert('No results');
        let csv = 'Subdomain,IPs,CNAME,Other,Depth\n';
        results.forEach(r => csv += `"${r.subdomain}","${r.ips.join('; ')}","${r.cname||''}","${r.other||''}",${r.depth}\n`);
        const blob = new Blob([csv], {type:'text/csv'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `subenum-${document.getElementById('target').value}.csv`;
        a.click();
        log('CSV exported', 'success');
    }

    function initUI() {
        const pDiv = document.getElementById('providerCheckboxes');
        defaultProviders.forEach((p,i) => pDiv.innerHTML += `<label class="pill flex items-center gap-1.5 bg-zinc-800 px-2 py-1.5 rounded-2xl cursor-pointer text-[10px]"><input type="checkbox" ${p.checked?'checked':''} onchange="defaultProviders[${i}].checked=this.checked" class="accent-violet-500 w-3 h-3"><span>${p.name}</span></label>`);

        const rDiv = document.getElementById('recordTypeCheckboxes');
        recordTypeList.forEach(r => rDiv.innerHTML += `<label class="pill flex items-center gap-1 bg-zinc-800 px-2 py-1.5 rounded-2xl cursor-pointer text-[10px]"><input type="checkbox" value="${r.value}" ${r.checked?'checked':''} class="accent-violet-500 w-3 h-3"><span>${r.label}</span></label>`);

        document.getElementById('concurrency').addEventListener('input', e => document.getElementById('concurrencyValue').textContent = e.target.value);
    }

    function showTab(n) {
        document.querySelectorAll('[id^="tabContent"]').forEach(el => el.classList.add('hidden'));
        document.getElementById('tabContent'+n).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active','bg-zinc-800'));
        document.getElementById('tab'+n).classList.add('active','bg-zinc-800');
        
        if (n === 2) { 
            updateDashboard(); 
            if (!animationFrame) startTrafficAnimation(); 
        } else {
            stopTrafficAnimation();
        }
    }

    function renderCustomProviders() {
        document.getElementById('customProvidersList').innerHTML = 
            customProviders.map((p,i) => 
                `<div class="flex justify-between bg-zinc-800 rounded-xl px-2 py-1 text-[10px]">
                    <span class="font-mono truncate">${p.url}</span>
                    <button onclick="removeCustom(${i})" class="text-red-400 hover:text-red-300 ml-2">√ó</button>
                </div>`
            ).join('');
    }

    function addCustomProvider() {
        const url = document.getElementById('customDoh').value.trim();
        if (!url) return;
        if (!url.startsWith('https://')) {
            alert('Must start with https://');
            return;
        }
        customProviders.push({name:url.split('//')[1]?.split('/')[0]||'Custom',url});
        renderCustomProviders();
        document.getElementById('customDoh').value = '';
        log(`Added: ${url}`, 'success');
    }

    function removeCustom(i) { 
        const removed = customProviders[i];
        customProviders.splice(i,1); 
        renderCustomProviders();
        log(`Removed: ${removed.url}`, 'info');
    }

    function uploadWordlist() { document.getElementById('wordlistUpload').click(); }
    
    function handleFileUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
            document.getElementById('wordlist').value = ev.target.result;
            const lineCount = ev.target.result.split('\n').filter(Boolean).length;
            log(`Loaded: ${file.name} (${lineCount})`, 'success');
        };
        reader.readAsText(file);
    }

    window.onload = () => {
        initUI();
        initTrafficCanvas();
        initCharts();
        showTab(0);

        // Auto-load full PSL
        loadFullPSL();

        document.getElementById('debugEnabled').addEventListener('change', e => {
            debugEnabled = e.target.checked;
            document.getElementById('debugTabBtn').classList.toggle('hidden', !debugEnabled);
            if (debugEnabled) log('Debug enabled', 'success');
        });

        // Keyboard navigation for pagination
        document.addEventListener('keydown', e => {
            // Only if results tab is active
            if (!document.getElementById('tabContent0').classList.contains('hidden')) {
                if (e.key === 'ArrowLeft' && currentPage > 1) {
                    changePage(-1);
                } else if (e.key === 'ArrowRight') {
                    const totalPages = Math.ceil(results.length / resultsPerPage);
                    if (currentPage < totalPages) {
                        changePage(1);
                    }
                }
            }
        });

        log('SubEnum v4.4.1 ready', 'success');
        log('Loading full PSL...', 'info');

        let updateTimeout;
        setInterval(() => {
            if (isRunning || !document.getElementById('tabContent2').classList.contains('hidden')) {
                if (updateTimeout) clearTimeout(updateTimeout);
                updateTimeout = setTimeout(() => updateDashboard(), 100);
            }
        }, 800);
    };
</script>
</body>
</html>
